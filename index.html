<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作委託平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, StrictMode } = React;
        const API_URL = "http://127.0.0.1:8000";

        // --- 共用元件 ---
        const Button = ({ children, onClick, variant = 'primary', className='' }) => {
            const styles = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-gray-500 text-white hover:bg-gray-600",
                success: "bg-green-600 text-white hover:bg-green-700",
                danger: "bg-red-600 text-white hover:bg-red-700",
                outline: "border border-blue-600 text-blue-600 hover:bg-blue-50"
            };
            return <button onClick={onClick} className={`px-4 py-2 rounded transition ${styles[variant]} ${className}`}>{children}</button>;
        };

        const Input = ({ label, type="text", value, onChange }) => (
            <div className="mb-3">
                <label className="block text-gray-700 font-bold mb-1">{label}</label>
                <input type={type} value={value} onChange={onChange} className="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
        );

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 className="text-xl font-bold">{title}</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-black text-2xl">&times;</button>
                    </div>
                    {children}
                </div>
            </div>
        );

        const StarRating = ({ rating, count, onClick }) => (
            <div onClick={onClick} className={`flex items-center space-x-1 ${count > 0 ? 'cursor-pointer hover:bg-gray-100' : ''} p-1 rounded transition`}>
                <span className="text-yellow-500 text-lg">★</span>
                <span className="font-bold text-gray-800">{rating}</span>
                <span className="text-gray-500 text-sm">({count} 評價)</span>
            </div>
        );

        // --- 功能型 Modal ---

        // 1. 查看歷史評價 Modal (顯示標籤已修正)
        // targetRole: 'client' (我們正在看甲方的歷史) 或 'freelancer' (我們正在看乙方的歷史)
        const HistoryModal = ({ userId, userName, targetRole, onClose }) => {
            const [data, setData] = useState(null);
            
            useEffect(() => {
                fetch(`${API_URL}/users/${userId}/stats`).then(r=>r.json()).then(setData);
            }, [userId]);

            // 根據「被查看者」的身分，顯示對應的維度標籤
            const labels = targetRole === 'client'
                ? ["需求合理性", "驗收難度", "合作態度"] // 這是看甲方(委託人)的成績單
                : ["產出品質", "執行效率", "合作態度"];   // 這是看乙方(接案人)的成績單

            return (
                <Modal title={`評價紀錄: ${userName}`} onClose={onClose}>
                    {!data ? <p>載入中...</p> : (
                        <div className="space-y-4">
                            <div className="bg-yellow-50 p-4 rounded text-center">
                                <div className="text-4xl font-bold text-yellow-600">{data.avg_rating}</div>
                                <div className="text-sm text-gray-600">總平均 (共 {data.review_count} 筆)</div>
                            </div>
                            <div className="space-y-3">
                                {data.reviews.map(r => (
                                    <div key={r.id} className="border-b pb-2">
                                        <div className="flex justify-between font-bold text-gray-700">
                                            <span>{r.reviewer_name}</span>
                                            <span className="text-xs text-gray-400">{new Date(r.created_at).toLocaleDateString()}</span>
                                        </div>
                                        <div className="flex flex-col space-y-1 text-sm text-gray-600 my-2 bg-gray-50 p-2 rounded">
                                            <div className="flex justify-between"><span>{labels[0]}:</span> <span className="text-yellow-600 font-bold">{r.rating_1}</span></div>
                                            <div className="flex justify-between"><span>{labels[1]}:</span> <span className="text-yellow-600 font-bold">{r.rating_2}</span></div>
                                            <div className="flex justify-between"><span>{labels[2]}:</span> <span className="text-yellow-600 font-bold">{r.rating_3}</span></div>
                                        </div>
                                        <p className="text-gray-800 italic">"{r.comment || "無文字評論"}"</p>
                                    </div>
                                ))}
                                {data.reviews.length === 0 && <p className="text-gray-500 text-center">暫無評論</p>}
                            </div>
                        </div>
                    )}
                </Modal>
            );
        };

        // 2. 提交評價 Modal (評分維度已修正)
        // role: 當前登入者的身分
        const ReviewFormModal = ({ project, role, token, onClose, onSuccess }) => {
            // 如果我是 Client (甲方)，我要評 Freelancer (乙方) -> 顯示乙方維度
            // 如果我是 Freelancer (乙方)，我要評 Client (甲方) -> 顯示甲方維度
            const labels = role === 'client' 
                ? ["產出品質", "執行效率", "合作態度"]  // 甲方評乙方 (評量乙方的表現)
                : ["需求合理性", "驗收難度", "合作態度"]; // 乙方評甲方 (評量甲方的表現)

            const [r1, setR1] = useState(5);
            const [r2, setR2] = useState(5);
            const [r3, setR3] = useState(5);
            const [comment, setComment] = useState("");

            const handleSubmit = async () => {
                const res = await fetch(`${API_URL}/projects/${project.id}/reviews`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating_1: r1, rating_2: r2, rating_3: r3, comment })
                });
                if(res.ok) { alert("評價成功！"); onSuccess(); onClose(); }
                else alert("評價失敗");
            };

            const RatingSelect = ({ label, val, setVal }) => (
                <div className="flex justify-between items-center mb-2 border-b border-gray-100 pb-2">
                    <span className="text-gray-700 font-medium">{label}</span>
                    <select value={val} onChange={e=>setVal(parseInt(e.target.value))} className="border p-1 rounded bg-white">
                        {[5,4,3,2,1].map(n => <option key={n} value={n}>{n} 星</option>)}
                    </select>
                </div>
            );

            return (
                <Modal title={`評價專案: ${project.title}`} onClose={onClose}>
                    <div className="mb-4 bg-blue-50 p-3 rounded text-sm text-blue-800">
                        {role === 'client' 
                            ? "請針對 乙方 (接案人) 進行評分：" 
                            : "請針對 甲方 (委託人) 進行評分："}
                    </div>
                    <div className="space-y-2">
                        <RatingSelect label={labels[0]} val={r1} setVal={setR1} />
                        <RatingSelect label={labels[1]} val={r2} setVal={setR2} />
                        <RatingSelect label={labels[2]} val={r3} setVal={setR3} />
                    </div>
                    <div className="mt-4">
                        <label className="block mb-1 font-bold">總體質性評論</label>
                        <textarea className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-400 focus:outline-none" rows="3" value={comment} onChange={e=>setComment(e.target.value)} placeholder="請輸入具體意見..."></textarea>
                    </div>
                    <div className="mt-4 flex justify-end space-x-2">
                        <Button variant="secondary" onClick={onClose}>取消</Button>
                        <Button onClick={handleSubmit}>送出評價</Button>
                    </div>
                </Modal>
            );
        };

        // --- 主頁面 ---
        
        const App = () => {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); // login, register, dashboard
            
            // 用於 Modal 的狀態
            // historyTarget: {id, name, role} -> role 用於決定顯示哪種維度標籤
            const [historyTarget, setHistoryTarget] = useState(null); 
            const [reviewTarget, setReviewTarget] = useState(null); 

            // API 封裝
            const api = async (url, method='GET', body=null) => {
                const opts = { method, headers: { 'Authorization': `Bearer ${token}` } };
                if (body && !(body instanceof FormData)) {
                    opts.headers['Content-Type'] = 'application/json';
                    opts.body = JSON.stringify(body);
                } else if (body) {
                    opts.body = body;
                }
                const res = await fetch(API_URL + url, opts);
                return res.ok ? (method === 'GET' || method.includes('POST') ? res.json() : {}) : null;
            };

            useEffect(() => {
                if(token) api('/users/me').then(u => { if(u) { setUser(u); setView('dashboard'); } else setToken(null); });
            }, [token]);

            const login = async (username, password) => {
                const fd = new FormData(); fd.append('username', username); fd.append('password', password);
                const res = await fetch(`${API_URL}/token`, { method: 'POST', body: fd });
                if(res.ok) {
                    const data = await res.json();
                    setToken(data.access_token); localStorage.setItem('token', data.access_token);
                } else alert("登入失敗");
            };

            const register = async (username, password, role) => {
                const res = await fetch(`${API_URL}/register`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({username, password, role}) 
                });
                if(res.ok) { alert("註冊成功，請登入"); setView('login'); } else alert("註冊失敗");
            };

            // --- 儀表板視圖 ---
            const Dashboard = () => {
                const [projects, setProjects] = useState([]);
                const [openProjects, setOpenProjects] = useState([]);
                const [formMode, setFormMode] = useState(false); 
                const [bidsModal, setBidsModal] = useState(null); 
                
                const [title, setTitle] = useState(""); const [desc, setDesc] = useState("");
                const [bidAmount, setBidAmount] = useState(""); const [bidMsg, setBidMsg] = useState("");

                const refresh = () => {
                    api('/projects/my').then(setProjects);
                    if(user.role === 'freelancer') api('/projects').then(setOpenProjects);
                };

                useEffect(refresh, []);

                // 委託人(甲方) 功能
                const createProject = async () => {
                    await api('/projects', 'POST', {title, description: desc});
                    setFormMode(false); refresh();
                };
                const viewBids = async (pid, pTitle) => {
                    const bids = await api(`/projects/${pid}/bids`);
                    setBidsModal({ pid, title: pTitle, list: bids });
                };
                const acceptBid = async (bidId) => {
                    if(confirm("確定接受此提案？專案將進入執行階段。")) { await api(`/bids/${bidId}/accept`, 'POST'); setBidsModal(null); refresh(); }
                };
                const handleWorkflow = async (pid, action) => {
                    const msg = action === 'complete' ? '確定驗收並結案？(結案後可進行評價)' : '確定退件？專案將退回進行中狀態。';
                    if(confirm(msg)) {
                        await api(`/projects/${pid}/${action}`, 'POST'); refresh();
                    }
                };

                // 接案人(乙方) 功能
                const submitBid = async (pid) => {
                    await api(`/projects/${pid}/bid`, 'POST', {amount: parseFloat(bidAmount), message: bidMsg});
                    alert("已提交提案"); setBidAmount(""); refresh();
                };
                const uploadFile = async (pid, file) => {
                    const fd = new FormData(); fd.append('file', file);
                    await api(`/projects/${pid}/submit_file`, 'POST', fd);
                    alert("檔案已上傳"); refresh();
                };

                return (
                    <div className="max-w-4xl mx-auto mt-6 bg-white p-6 rounded shadow">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h2 className="text-2xl font-bold text-gray-800">
                                歡迎, {user.username} ({user.role === 'client' ? '甲方/委託人' : '乙方/接案人'})
                            </h2>
                            <Button variant="secondary" onClick={()=>{setToken(null); localStorage.removeItem('token'); setView('login');}}>登出</Button>
                        </div>

                        {/* 甲方 (Client) 介面 */}
                        {user.role === 'client' && (
                            <div>
                                <Button onClick={()=>setFormMode(true)} className="mb-4">建立新委託</Button>
                                {formMode && (
                                    <div className="bg-gray-50 p-4 mb-4 rounded border">
                                        <Input label="專案標題" value={title} onChange={e=>setTitle(e.target.value)} />
                                        <Input label="需求描述" value={desc} onChange={e=>setDesc(e.target.value)} />
                                        <div className="flex gap-2">
                                            <Button onClick={createProject}>送出</Button>
                                            <Button variant="secondary" onClick={()=>setFormMode(false)}>取消</Button>
                                        </div>
                                    </div>
                                )}
                                
                                <h3 className="text-xl font-bold mb-2 text-gray-700">我的委託列表</h3>
                                {projects.map(p => (
                                    <div key={p.id} className="border p-4 mb-3 rounded hover:shadow transition relative">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h4 className="font-bold text-lg text-blue-800">{p.title}</h4>
                                                <p className="text-gray-600 text-sm mb-1">{p.description}</p>
                                                <span className={`px-2 py-1 text-xs rounded text-white 
                                                    ${p.status==='open'?'bg-green-500':p.status==='completed'?'bg-gray-500':'bg-blue-500'}`}>
                                                    {p.status === 'open' ? '開放提案中' : p.status === 'in_progress' ? '執行中' : p.status === 'submitted' ? '待驗收' : '已結案'}
                                                </span>
                                            </div>
                                            <div className="flex flex-col gap-2">
                                                {p.status === 'open' && <Button variant="outline" onClick={()=>viewBids(p.id, p.title)}>查看提案</Button>}
                                                {p.status === 'submitted' && (
                                                    <div className="flex gap-2 items-center">
                                                        <a href={API_URL+p.submission_file_url} target="_blank" className="text-blue-600 underline text-sm px-2">下載成果</a>
                                                        <Button variant="success" onClick={()=>handleWorkflow(p.id, 'complete')}>驗收通過</Button>
                                                        <Button variant="danger" onClick={()=>handleWorkflow(p.id, 'reject')}>退件</Button>
                                                    </div>
                                                )}
                                                {p.status === 'completed' && !p.has_reviewed && (
                                                    <Button onClick={()=>setReviewTarget(p)}>評價乙方</Button>
                                                )}
                                                {p.status === 'completed' && p.has_reviewed && <span className="text-gray-400 text-sm font-bold">✓ 已評價</span>}
                                            </div>
                                        </div>
                                    </div>
                                ))}

                                {/* 查看提案 Modal */}
                                {bidsModal && (
                                    <Modal title={`提案管理: ${bidsModal.title}`} onClose={()=>setBidsModal(null)}>
                                        {bidsModal.list.length === 0 ? "尚無人提案" : bidsModal.list.map(bid => (
                                            <div key={bid.id} className="border-b py-3 flex justify-between items-center">
                                                <div>
                                                    <div className="font-bold text-gray-800 flex items-center gap-2">
                                                        {bid.freelancer_name} (乙方)
                                                        {/* 甲方查看乙方的評價 -> 傳入 targetRole='freelancer' */}
                                                        <StarRating 
                                                            rating={bid.freelancer_avg_rating} 
                                                            count={bid.freelancer_review_count} 
                                                            onClick={()=>setHistoryTarget({id: bid.freelancer_id, name: bid.freelancer_name, role: 'freelancer'})}
                                                        />
                                                    </div>
                                                    <div className="text-green-600 font-bold">${bid.amount}</div>
                                                    <p className="text-sm text-gray-500">{bid.message}</p>
                                                </div>
                                                <Button onClick={()=>acceptBid(bid.id)}>選擇此提案</Button>
                                            </div>
                                        ))}
                                    </Modal>
                                )}
                            </div>
                        )}

                        {/* 乙方 (Freelancer) 介面 */}
                        {user.role === 'freelancer' && (
                            <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="text-xl font-bold mb-4 border-b pb-2 text-gray-700">開放中的委託 (可提案)</h3>
                                    {openProjects.map(p => (
                                        <div key={p.id} className="border p-4 mb-3 rounded bg-white shadow-sm hover:shadow-md transition">
                                            <h4 className="font-bold text-blue-700">{p.title}</h4>
                                            {/* 乙方查看甲方的評價 -> 傳入 targetRole='client' */}
                                            <div className="flex items-center gap-2 mb-2 mt-1">
                                                <span className="text-sm text-gray-500">甲方評價:</span>
                                                <StarRating 
                                                    rating={p.owner_avg_rating} 
                                                    count={p.owner_review_count} 
                                                    onClick={()=>setHistoryTarget({id: p.owner_id, name: "委託人(甲方)", role: 'client'})}
                                                />
                                            </div>
                                            <p className="text-gray-600 text-sm mb-3">{p.description}</p>
                                            <div className="bg-gray-50 p-3 rounded">
                                                <div className="flex gap-2 mb-2">
                                                    <input placeholder="報價金額" type="number" className="border p-1 w-24 text-sm rounded" onChange={e=>setBidAmount(e.target.value)} />
                                                    <input placeholder="留言/優勢說明" className="border p-1 w-full text-sm rounded" onChange={e=>setBidMsg(e.target.value)} />
                                                </div>
                                                <Button className="w-full text-sm py-1" onClick={()=>submitBid(p.id)}>提交提案</Button>
                                            </div>
                                        </div>
                                    ))}
                                    {openProjects.length === 0 && <p className="text-gray-500">目前沒有開放的委託。</p>}
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold mb-4 border-b pb-2 text-gray-700">我的承接紀錄</h3>
                                    {projects.map(p => (
                                        <div key={p.id} className="border p-4 mb-3 rounded bg-gray-50">
                                            <h4 className="font-bold text-gray-800">{p.title}</h4>
                                            <span className={`text-xs px-2 py-0.5 rounded text-white mb-2 inline-block
                                                ${p.status==='in_progress'?'bg-blue-500':p.status==='submitted'?'bg-purple-500':'bg-green-600'}`}>
                                                {p.status === 'in_progress' ? '執行中' : p.status === 'submitted' ? '已提交待驗' : '已結案'}
                                            </span>
                                            
                                            {p.status === 'in_progress' && (
                                                <div className="mt-2 p-2 bg-white rounded border">
                                                    <p className="text-sm mb-1 font-bold">上傳成果檔案:</p>
                                                    <input type="file" onChange={e=>uploadFile(p.id, e.target.files[0])} className="text-sm w-full" />
                                                </div>
                                            )}
                                            {p.status === 'submitted' && <p className="text-sm text-blue-600 mt-2 font-bold">已提交，等待甲方驗收...</p>}
                                            {p.status === 'completed' && !p.has_reviewed && (
                                                <Button className="mt-2 w-full" onClick={()=>setReviewTarget(p)}>評價甲方</Button>
                                            )}
                                            {p.status === 'completed' && p.has_reviewed && <p className="text-sm text-green-600 mt-2 font-bold">✓ 已完成評價</p>}
                                        </div>
                                    ))}
                                    {projects.length === 0 && <p className="text-gray-500">尚無承接紀錄。</p>}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // --- 登入/註冊表單 ---
            const AuthForm = () => {
                const [isReg, setIsReg] = useState(false);
                const [u, setU] = useState(""); const [p, setP] = useState(""); const [r, setR] = useState("client");
                
                const submit = (e) => {
                    e.preventDefault();
                    isReg ? register(u, p, r) : login(u, p);
                };

                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-200">
                        <form onSubmit={submit} className="bg-white p-8 rounded shadow-lg w-96">
                            <h2 className="text-3xl font-bold mb-6 text-center text-blue-600">{isReg ? "註冊帳號" : "系統登入"}</h2>
                            <Input label="帳號" value={u} onChange={e=>setU(e.target.value)} />
                            <Input label="密碼" type="password" value={p} onChange={e=>setP(e.target.value)} />
                            {isReg && (
                                <div className="mb-4">
                                    <label className="block text-gray-700 font-bold mb-1">角色選擇</label>
                                    <select value={r} onChange={e=>setR(e.target.value)} className="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                                        <option value="client">甲方 (委託人)</option>
                                        <option value="freelancer">乙方 (接案人)</option>
                                    </select>
                                </div>
                            )}
                            <Button type="submit" className="w-full mb-4 text-lg">{isReg ? "註冊" : "登入"}</Button>
                            <p className="text-center text-blue-500 cursor-pointer text-sm hover:underline" onClick={()=>setIsReg(!isReg)}>
                                {isReg ? "已有帳號? 點此登入" : "沒有帳號? 點此註冊"}
                            </p>
                        </form>
                    </div>
                );
            };

            return (
                <div>
                    {view === 'dashboard' ? <Dashboard /> : <AuthForm />}
                    
                    {/* 全域 Modal 渲染 */}
                    {historyTarget && (
                        <HistoryModal 
                            userId={historyTarget.id} 
                            userName={historyTarget.name}
                            targetRole={historyTarget.role} // 傳入目標角色以顯示正確維度
                            onClose={()=>setHistoryTarget(null)} 
                        />
                    )}
                    {reviewTarget && (
                        <ReviewFormModal 
                            project={reviewTarget} 
                            role={user.role} 
                            token={token}
                            onClose={()=>setReviewTarget(null)} 
                            onSuccess={()=>window.location.reload()} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StrictMode><App /></StrictMode>);
    </script>
</body>
</html>